<!doctype html>

<!-- ASSIGN OUR ANGULAR MODULE -->
<html ng-app="scotchTodo">
<head>
	<!-- META -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1"><!-- Optimize mobile viewport -->

	<title>MEETAPP</title>

	<!-- SCROLLS -->
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css"><!-- load bootstrap -->
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css">
	<style>
		html 					{ overflow-y:scroll; }
		body 					{ padding-top:50px; }
		#todo-list 				{ margin-bottom:30px; }
		#todo-form 	 			{ margin-bottom:50px; }
	</style>

	<!-- SPELLS -->
	<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.16/angular.min.js"></script><!-- load angular -->

	<script src="js/controllers/main.js"></script> <!-- load up our controller -->
	<script src="js/core.js"></script> <!-- load our main application -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://connect.facebook.com/en_US/messenger.Extensions.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
</head>
<!-- SET THE CONTROLLER -->
<body ng-controller="mainController">
<script>
		var socket = io();
		var context = {}
		var state = {}
		$(document).ready(function(){MessengerExtensions.getContext('131709420816962',
 		 function success(thread_context){
 		 	context = thread_context;
			document.getElementById("mapholder").innerHTML = JSON.stringify(context);
		    	$.ajax({
			    url: '/state',
			    data: context,
			    type: 'POST',
			    cache: false,
			    success: function(response) {
			    state = response;
			    console.log(state);
			    if (state.state===1){
			    	$('.page1').hide();
				$('.page2').show();
				$('.page3').hide();
				    Object.keys(state.locations).forEach(function(key){
					    $('#locList').append("<div class='row'>"+state.locations[key][1]+":"+state.locations[key][0]['addr']+"</div>");
				    });
				$('#ppref').html("You want to meet at a "+state.preference);
			    }
			    else if(state.state === 0){
				    $('.page1').show();
				    $('.page2').hide();
				    $('.page3').hide();
				    console.log(response);
			    }
			    else {
				    $('.page1').hide();
				    $('.page2').hide();
				    $('page3').show();
				    var i =0;
				    socket.emit("recos");
				    socket.emit(state);

				   state.recommendations.slice(0,4).forEach(function (arrayItem)
				  {
					  if(i===0){
						  $('#suggestions').append('<div class="carousel-item card active"><div class="card-header">'+arrayItem[0]+'</div><div class="card-body">Text Goes Here</div></div>');
					  i=1;}

					  else{
						$('#suggestions').append('<div class="carousel-item card"><div class="card-header">'+arrayItem[0]+'</div><div class="card-body">Text Goes Here</div></div>');
					  }
				});

			    }
			    },
			    error: function(error) {
				console.log(error);
			    }
			});

 		 },
 		 function error(err){
 		    // error
 		  }
		 );
		MessengerExtensions.askPermission(
		  function(permission_response) {
		    // Person grants or rejects the asked permission.
		    let permissions = permission_response.permissions; // list of all permissions granted
		    let isGranted = permission_response.isGranted;

		    if (isGranted) {
		      // User has granted user_profile permission
		    }
		  }, function(errorCode, errorMessage) {
		    // Error occurred
		  },
		  "user_profile"
		);
		$('#preference').click(function(e){
			$('#demo').html("CLicked Prefbut");
			var pref = $("#textPref").val()
		    	$.ajax({
			    url: '/preference',
			    data: {'c':context,'pref':pref},
			    cache: false,
			    type: 'POST',
			    success: function(response) {
			    			    },
			    error: function(error) {
				console.log(error);
			    }
			});
		});
		$('#showBut').click(function(e){
		    	$.ajax({
			    url: '/getResults',
			    data: context,
			    cache: false,
			    type: 'POST',
			    success: function(response) {
			    			    },
			    error: function(error) {
				console.log(error);
			    }
			});
		});

		$('#locButton').click(function(e){
			document.location.href = '/getloc'+'?tid='+context.tid+'&psid='+context.psid;
});
});
</script>

	<div class="page1 container">

		<!-- HEADER AND TODO COUNT -->
		<h1>Where do you want to meet?</h1>
		<div id="todo-form" class="row">
			<form>
				<div class="form-group">

					<input type="text" class="form-control input-lg text-center" id="textPref" placeholder="cafe or bar or whatever" ng-model="formData.text">
				</div>

				<!-- createToDo() WILL CREATE NEW TODOS -->
				<button type="input" class="btn btn-primary btn-lg" id="preference">Proceed</button>
				<p id="demo">results here</p>
				<div id="mapholder"></div>
			</form>
		</div>


	</div>
	<div class="page2 container">
		<h1>Update Locations</h1>
		<h3>Share this link in the chat window so your friends can add their locations</h3>
		<div id="locList" class="container">
		</div>
		<button type="input" class="btn btn-primary btn-lg" id="locButton">Add/update my location</button>
		<p id="ppref"></p>
		<button type="input" class="btn btn-primary btn-lg" id="showBut">Show me  what you GOOOT</button>
	</div>
	<div class="page3 container">
		<h1>Here are our picks</h1>
		  <ul id="indicators" class="carousel-indicators">
    <li data-target="#demo" data-slide-to="0" class="active"></li>
    <li data-target="#demo" data-slide-to="1"></li>

    <li data-target="#demo" data-slide-to="2"></li>
    <li data-target="#demo" data-slide-to="3"></li>
		  </ul>
		<div id="suggestions" class="carousel carousel slide" data-ride="carousel">
		</div>
	</div>

</body>
</html>
